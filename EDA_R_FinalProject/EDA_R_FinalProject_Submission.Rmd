Exploration of WA DOH School Exemption Data over 3 School Years by Andrew T. Bauman
========================================================
#Introduction#

Recent news media coverage and my own personal interest inspired me to explore a school vaccination data set for WA state.  WA DOH employees generously assembled 3 data sets for my project for school years 2011-2012, 2012-2013, and 2013-2014.  The 2011-2012 set is the most comprehensive in terms of school covered and relevant fields.  Each data set contains an observation about a school.  The 3 data sets were bound into one data set, then explored.  

The initial data and cleaning/assembly of the combined data frame can be found here:
[githubrepo](https://github.com/baumanab/EDA_R_Udacity/tree/master/EDA_R_FinalProject/EDA_R_FinalProject.Rmd)

Additional cleaning and wrangling can be found here:
[githubrepo](https://github.com/baumanab/EDA_R_Udacity/blob/master/EDA_R_FinalProject/EDA_R_FinalProject_WADOH_DataFrameWrangle.Rmd)

An initial exploration and some additional corrections for student enrollment, is here:
[githubrepo](https://github.com/baumanab/EDA_R_Udacity/blob/master/EDA_R_FinalProject/WADOH_DataExplore.Rmd)


The current state is a rough approach and far from perfect.  I plan to revisit this as I discover additional elements that need cleaning.  I am currently working on a more readable and organized version of the data wrangling using piping, so that changes are easy to make and push to the .rds file called as data for this project.

There are some aspects of vaccination and the spread of disease through populations that are best left to subject matter experts (SMEs).  I consulted CDC publications throughout this analysis and I encourage the reader to do the same.
```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Load libraries

library(dplyr)
library(tidyr)
library(ggplot2)
library(gridExtra)
library(reshape2)
library(tidyr)
library(RColorBrewer)
library(scales)
```

```{r echo=FALSE, Load_the_Data}

#school vaccine exemption data, reported == "Yes" for WA State, school years 2011-2012, 2012-2013, 2013-2014
vaccReported <- readRDS("data/vaccReported")


#temp convenience
#setwd("Udacity//dataAnalysisR/EDA_R_Udacity/EDA_R_FinalProject/")
#save.image("project_pause.RData")
#load("project_pause.RData")
```
##Alter Data##

* Select fields from WA DOH 2011 - 2012, 2012-2013, and 2013 - 2014 School Year data set.*
* Subset or reported only*
* Subset by enrollement 10 - 2500 students all school years*
* Subset by enrollment 10 - 2500 students most recent school year (2013)*
* Subset by enrollment 100 - 2500 students*
``` {r echo = FALSE ,alter_data}
#limit fields
fields <- c("school_year", "school_code", "school_name", "school_type", "school_city","school_state", "school_zip", "school_county", "school_district", "district_code", "enrolled", "total_exemptions", "medical_exempt", "nonmedical_exempt", "exempt_MMR", "percent_exempt", "percent_medical_exempt","percent_nonmedexempt", "percent_exempt_MMR")


vaccReported <- subset(arrange(vaccReported, desc(enrolled)), na.rm = TRUE, select = fields 
                       )
vaccReported_NLT_10_NGT_2500 <- subset(vaccReported,vaccReported$enrolled >= 10 & vaccReported$enrolled <= 2500) %>%
  arrange(desc(percent_exempt))

vaccReported_NLT_10_NGT_2500_2013 <- subset(vaccReported_NLT_10_NGT_2500, school_year == "2013")

vaccReported_NLT_100_NGT_2500 <- subset(vaccReported,vaccReported$enrolled >= 100 & vaccReported$enrolled <= 2500) %>%
  arrange(desc(percent_exempt))


brks <- c(1, 5, 10, 50, 100, 500, 1000, 5000, 10000)

brks2 <- c(.25,.5, 1, 2.5, 5, 10, 15, 25, 50, 75, 100)

brks3 <- c(.1,.25,.5,1,5,10,50)

```

# Univariate Plots Section

##Distribution of enrolled students##
```{r echo=FALSE, dist_enrollment}
#vacc
names(vaccReported)
str(vaccReported)
summary(vaccReported)

#distribution of enrollment
ggplot(aes(x = enrolled), data = vaccReported) + 
  geom_histogram(binwidth = 30,  color = 'black',fill = '#F79420') +
  scale_x_continuous(limits = c(0,5100), breaks = seq(0, 5100, 500))
```

This is a long tailed distribution, a feature exhibited by most distributions in this data set.  Log transformations are performed to visualize the data.

```{r echo = FALSE, dist_enrollment_cont}


ggplot(aes(x = enrolled), data = vaccReported) + 
  geom_histogram(binwidth = log(1.25),  color = 'black',fill = '#F79420') +
  scale_x_log10(breaks = brks) +
  xlab("Log10(enrolled)")

```

* Range:  1 - 5076*
* Most of the data falls between ~ 100 - 1000 students per school*

##Distribution of total exemptions##
```{r echo=FALSE, total_exemptions}


#summary of total exemptions
summary(vaccReported$total_exemptions)
by(vaccReported$total_exemptions, vaccReported$school_year,summary)

#total exemption rate
summary(vaccReported$percent_exempt)
by(vaccReported$percent_exempt, vaccReported$school_year,summary)


#distribution of total exemptions

ggplot(aes(x = total_exemptions), data = vaccReported) + 
  geom_histogram(binwidth = 5,  color = 'black',fill = '#F79420') +
  scale_x_continuous(limits = c(0,450), breaks = seq(0, 450, 50))


ggplot(aes(x = total_exemptions), data = vaccReported) + 
  geom_histogram(binwidth = log(1.2),  color = 'black',fill = '#F79420') +
  scale_x_log10(breaks = brks) +
  xlab("Log10(Total Exemptions)")
  

#total exempt by year

ggplot(aes(x = total_exemptions), data = vaccReported) + 
  geom_histogram(binwidth =log(1.25),  color = 'black',fill = '#F79420') +
  facet_wrap(~school_year) +
  scale_x_log10(breaks = brks) +
  xlab("Log10(Total Exemptions)")



#percent total exemptions

ggplot(aes(x = percent_exempt, y = ..density..), data = vaccReported) +
  geom_freqpoly(binwidth = .1, aes(color = school_year)) +
  scale_x_log10(breaks = brks2)
  
##freqpoly proportion of percent exempt, by county, color = year
ggplot(aes(x = percent_exempt, y = ..count../sum(..count..)), data = vaccReported) +
  geom_freqpoly(binwidth = log(1.25), aes(color = school_year)) +
  facet_wrap(~school_county) +
  scale_x_log10()



##freqpoly density of percent exempt, by county, color = year
ggplot(aes(x = percent_exempt, y = ..density..), data = vaccReported) +
  geom_freqpoly(binwidth = .5, aes(color = school_year)) +
  facet_wrap(~school_county) +
  scale_x_log10()

#plot select counties to compare to King
  
ggplot(aes(x = percent_exempt, y = ..density..), data = subset(vaccReported, school_county == "KING" | school_county == "FERRY" | school_county == "CLARK" | school_county == "PIERCE" | school_county == "SAN JUAN")) +
  geom_freqpoly(binwidth = .5, aes(color = school_county, size = 1.25, alpha = .5)) +
  scale_x_log10()

```

* Range: 0 - 436*
* Rate:  0 - 100%, ~ 6.6% mean for all 3 school years*
* The highest density data is from ~ 10 - 75 students per school*
* Year to year distributions are similiar for total and rate*
* most schools fall into a rate range of 2-25%*
* King County has the highest proportion of exemptions*
* There appears to be some smaller counties (i.e. Ferry, San Juan) and others with more density at higher exemption rates than King and Pierce county (most populous counties in WA)*


**Note:**  Higher exemption rates of ~ > 50% appear to be associated with lower levels of enrollment (< 100 students).  This will be investigated in the bivariate section.



##Medical Exemptions##
```{r echo=FALSE, medical_exemptions}

#explore medical exemptions
summary(vaccReported$medical_exempt)
by(vaccReported$medical_exempt, vaccReported$school_year,summary)

#explore percent medical exempt
summary(vaccReported$percent_medical_exempt)
by(vaccReported$percent_medical_exempt, vaccReported$school_year,summary)



#medical exempt

ggplot(aes(x = medical_exempt), data = vaccReported) + 
  geom_histogram(binwidth = log(1.25),  color = 'black',fill = '#F79420') +
  scale_x_log10(breaks = brks) +
  xlab("Log10(medical_exemptions)")

ggplot(aes(x = medical_exempt), data = vaccReported) + 
  geom_histogram(binwidth = log(1.25),  color = 'black',fill = '#F79420') +
  facet_wrap(~school_year) +
  scale_x_log10(breaks = brks) +
  xlab("Log10(medical_exemptions)")

#percent medical exemptions

ggplot(aes(x = percent_medical_exempt, y = ..density..), data = vaccReported) +
  geom_freqpoly(binwidth = log(1.25)) +
  scale_x_log10(breaks = brks3)



ggplot(aes(x = percent_medical_exempt, y = ..density..), data = vaccReported) +
  geom_freqpoly(binwidth = log(1.25), aes(color = school_year)) +
  scale_x_log10(breaks = brks3)
  
##freqpoly proportion of percent medical exempt, by county, color = year
ggplot(aes(x = percent_medical_exempt, y = ..count../sum(..count..)), data = subset(vaccReported, vaccReported$percent_medical_exempt > 0)) +
  geom_freqpoly(binwidth = log(1.25), aes(color = school_year)) +
  facet_wrap(~school_county) +
  scale_x_log10()

##freqpoly density of percent medical exempt, by county, color = year
ggplot(aes(x = percent_medical_exempt, y = ..density..), data = vaccReported) +
  geom_freqpoly(binwidth = log(1.25), aes(color = school_year)) +
  facet_wrap(~school_county) +
  scale_x_log10()

```

* Range of 0-214 exemptions*
* Substantial rate increase from 2012 -> 2013*
* Most schools have 1-10 students with medical exemptions*
* The rate range is ` 0 -33% with most schols falling between ~0.1 and 5%*
* The mean rate rose from .55% to 1.08% from 2011 -> 2013*
* Overall distribution of rate shifts towards higher rates from 2011 -> 2013*
* King County*
  * highest proportion*
  * substantial shift to higer rates from 2011 -> 2013*
  * there is a distinct spike at > 10%*
* Columbia county has not reported any medical exemptions for any year*

##Non-medical Exemptions##
```{r echo=FALSE, nonmedical_exemptions}
#explore non-medical exemptions
summary(vaccReported$nonmedical_exempt)
by(vaccReported$nonmedical_exempt, vaccReported$school_year,summary)

summary(vaccReported$percent_nonmedexempt)
by(vaccReported$percent_nonmedexempt, vaccReported$school_year,summary)

#non-medical exempt

ggplot(aes(x = nonmedical_exempt), data = vaccReported) + 
  geom_histogram(binwidth = log(1.25),  color = 'black',fill = '#F79420') +
  scale_x_log10(breaks = brks2) +
  xlab("Log10(nonmedical_exemptions)")

ggplot(aes(x = nonmedical_exempt), data = vaccReported) + 
  geom_histogram(binwidth = log(1.25),  color = 'black',fill = '#F79420') +
  facet_wrap(~school_year) +
  scale_x_log10() +
  xlab("Log10(nonmedical_exemptions)")


#percent non-medical exemptions

ggplot(aes(x = percent_nonmedexempt, y = ..density..), data = vaccReported) +
  geom_freqpoly(binwidth = .1, aes(color = school_year)) +
  scale_x_log10(breaks = brks3)
  
##freqpoly proportion of percent nonmedical exempt, by county, color = year
ggplot(aes(x = percent_nonmedexempt, y = ..count../sum(..count..)), data = vaccReported) +
  geom_freqpoly(binwidth = .5, aes(color = school_year)) +
  facet_wrap(~school_county) +
  scale_x_log10()

##freqpoly density of percent nonmedical exempt, by county, color = year
ggplot(aes(x = percent_nonmedexempt, y = ..density..), data = vaccReported) +
  geom_freqpoly(binwidth = .5, aes(color = school_year)) +
  facet_wrap(~school_county) +
  scale_x_log10()

```

* Range 0 - 330 with most schools haveing ~8-75 nonmedical exempt students*
* Mean fell by ~ 5 students per school 2011 -> 2013*
* Rate of 0 -100% with most schools at ~ 1 - 20% nonmedical exempt*
* No substantial change in mean rate (~6%) from 2011 -> 2013*
* King County has the largest proportion of nonmedical exempt*
* Ferry and San Juan counties distributiion is at a higher % than King County*

##MMR Exemptions##
```{r echo=FALSE, MMR_exemptions}
#MMR exemptions

summary(vaccReported$exempt_MMR)
by(vaccReported$exempt_MMR, vaccReported$school_year,summary)

summary(vaccReported$percent_exempt_MMR)
by(vaccReported$percent_exempt_MMR, vaccReported$school_year,summary)


ggplot(aes(x = exempt_MMR), data = vaccReported) + 
  geom_histogram(binwidth = log(1.25),  color = 'black',fill = '#F79420') +
  scale_x_log10(breaks = brks) 


ggplot(aes(x = exempt_MMR), data = vaccReported) + 
  geom_histogram(binwidth = log(1.25),  color = 'black',fill = '#F79420') +
  facet_wrap(~school_year) +
  scale_x_log10() 
  

#percent exempt MMR

ggplot(aes(x = percent_exempt_MMR, y = ..density..), data = vaccReported) +
  geom_freqpoly(binwidth = log(1.25), aes(color = school_year)) +
  scale_x_log10(breaks = brks3)
  
##freqpoly proportion of percent exempt MMR, by county, color = year
ggplot(aes(x = percent_exempt_MMR, y = ..count../sum(..count..)), data = vaccReported) +
  geom_freqpoly(binwidth = .5, aes(color = school_year)) +
  facet_wrap(~school_county) +
  scale_x_log10()

##freqpoly density of percent exempt MMR, by county, color = year
ggplot(aes(x = percent_exempt_MMR, y = ..density..), data = vaccReported) +
  geom_freqpoly(binwidth = .5, aes(color = school_year)) +
  facet_wrap(~school_county) +
  scale_x_log10()

ggplot(aes(x = percent_exempt_MMR, y = ..density..), data = vaccReported) +
  geom_freqpoly(binwidth = .5, aes(color = school_year)) +
  facet_wrap(~school_county) +
  scale_x_log10()



```

* Range 0-269 with most schools haveing 3 - 40 MMR exempt students*
* Rate 0 -100% with most schools falling between ~0.5 - 20%*
* No substntial change in total mean or mean rate from 2011 -> 2013*
* King County has the largest proportion of nonmedical exempt*
* Ferry and San Juan counties distributiion is at a higher % than King County*

##Explore Exemption Types##

Gather terms for exemption type (melt) the dataframe, the calculate the % of total exemptions that are of a particular type (medical or non-medical)  While this is not a tidy data frame it is a convenient way to look at observations by exemption type.  I am using this to develop a better understanding of the propotion of exemptions that are non-medical.
```{r echo=FALSE, exemption_types}

melt <- gather(vaccReported_NLT_10_NGT_2500,exemption_type,exemptions,medical_exempt, nonmedical_exempt)

str(melt)
names(melt)
summary(melt)

#add percent by exemption type
melt$percent_exemption_type <- round((melt$exemptions/melt$total_exemptions)*100,digits = 2)

str(melt)
names(melt)
summary(melt)
ggplot(data = melt, aes(x = percent_exemption_type, y = ..density..)) +
  geom_freqpoly(binwidth = log(1.25),aes(color = exemption_type)) +
  facet_wrap(school_type ~ school_year) +
  scale_x_log10()

ggplot(data = melt, aes(x = percent_exemption_type, y = ..count../sum(..count..))) +
  geom_freqpoly(binwidth = log(1.25),aes(color = exemption_type)) +
  facet_wrap(school_type ~ school_year) +
  scale_x_log10()

```

Public and private schools have similiar distributions and rates of both types of exemptions, for all three school years.  Public schools have a larger proportion of exempitons of both types.


# Univariate Analysis

### What is the structure of your dataset?
My data set contains 6696 observations of 19 variables.  There are 2 categorical variables:
school_year: 3 levels [2011, 2012, 2013]
school_type: 2 levels [public, not public]


### What is/are the main feature(s) of interest in your dataset?
Number of exemptions per school: total, by type (medical and non-medical), and MMR.

### What other features in the dataset do you think will help support your investigation into your feature(s) of interest?
School enrollment and school type.

### Did you create any new variables from existing variables in the dataset?
I created % of each total and each exemption using the number respective to the exemtion and enrollment, for each schools.

### Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?
I was suprised to see that two of the smaller counties, Ferry and San Juan had distributions shifted to higher percent of all exemptions than King County.  The narrative in the Seattle media led me to believe that the highest exemption rates would be observed in King County and the Seattle area in general.  I was also surprised to find the public and private schools have similiar distribuions, albeit different proportions, respective to exemption type.  This is the case on a proportion basis, but not for rate.  However, the schools in these counties tend to be much smaller so the rates shift dramatically per exempt student.  There was substantial tidying of the orignal data sets as per the github links in the introduction.  I extracted a subset of the data consisting of only schools that reported exemptions for the three schools years.  This elminated ~ 1200 observations but was necessary since non-reporting schools are missing all exemption values and typcially enrollment as well.



# Bivariate Plots Section

##Group by Attribute##
Group observations by county, city, zip, etc. for the most recent school year, 2013-2014.  
```{r echo=FALSE, group_by_attribute}

#group by county

by_county_exempt <- vaccReported_NLT_10_NGT_2500_2013 %>%  group_by(school_county) %>% 
  summarize(mean_percent_exempt = round(mean(percent_exempt, na.rm=TRUE), 2), 
            median_percent_exempt = round(median(percent_exempt, na.rm=TRUE), 2), 
            max_percent_exempt = round(max(percent_exempt, na.rm=TRUE), 2), 
            min_percent_exempt = round(min(percent_exempt, na.rm=TRUE), 2), 
            schools=n(), 
            students=sum(enrolled, na.rm=TRUE)) %>%
  na.omit() %>% 
  arrange(desc(mean_percent_exempt))

by_county_nonmedexempt <- vaccReported_NLT_10_NGT_2500_2013 %>%  group_by(school_county) %>% 
  summarize(mean_percent_nonmedexempt = round(mean(percent_nonmedexempt, na.rm=TRUE), 2), 
            median_percent_nonmedexempt = round(median(percent_nonmedexempt, na.rm=TRUE), 2), 
            max_percent_nonmedexempt = round(max(percent_nonmedexempt, na.rm=TRUE), 2), 
            min_percent_nonmedexempt = round(min(percent_nonmedexempt, na.rm=TRUE), 2), 
            schools=n(), 
            students=sum(enrolled, na.rm=TRUE)) %>% 
  na.omit() %>% 
  arrange(desc(mean_percent_nonmedexempt))


by_county_medexempt <- vaccReported_NLT_10_NGT_2500_2013 %>%  group_by(school_county) %>% 
  summarize(mean_percent_nonmedexempt = round(mean(percent_nonmedexempt, na.rm=TRUE), 2), 
            median_percent_nonmedexempt = round(median(percent_nonmedexempt, na.rm=TRUE), 2), 
            max_percent_nonmedexempt = round(max(percent_nonmedexempt, na.rm=TRUE), 2), 
            min_percent_nonmedexempt = round(min(percent_nonmedexempt, na.rm=TRUE), 2), 
            schools=n(), 
            students=sum(enrolled, na.rm=TRUE)) %>% 
  na.omit() %>% 
  arrange(desc(mean_percent_nonmedexempt))


by_county_medexempt <- vaccReported_NLT_10_NGT_2500_2013 %>%  group_by(school_county) %>% 
  summarize(mean_percent_medical_exempt = round(mean(percent_medical_exempt, na.rm=TRUE), 2), 
            median_percent_medical_exempt = round(median(percent_medical_exempt, na.rm=TRUE), 2), 
            max_percent_medical_exempt = round(max(percent_medical_exempt, na.rm=TRUE), 2), 
            min_percent_medical_exempt = round(min(percent_medical_exempt, na.rm=TRUE), 2), 
            schools=n(), 
            students=sum(enrolled, na.rm=TRUE)) %>% 
  na.omit() %>% 
  arrange(desc(mean_percent_medical_exempt))


by_county_MMR <- vaccReported_NLT_10_NGT_2500_2013 %>%  group_by(school_county) %>% 
  summarize(mean_percent_exempt_MMR = round(mean(percent_exempt_MMR, na.rm=TRUE), 2), 
            median_percent_exempt_MMR = round(median(percent_exempt_MMR, na.rm=TRUE), 2), 
            max_percent_exempt_MMR = round(max(percent_exempt_MMR, na.rm=TRUE), 2), 
            min_percent_exempt_MMR = round(min(percent_exempt_MMR, na.rm=TRUE), 2), 
            schools=n(), 
            students=sum(enrolled, na.rm=TRUE)) %>% 
  na.omit() %>% 
  arrange(desc(mean_percent_exempt_MMR))

#merge county groups and sort by students enrolled

county_group <- inner_join(by_county_medexempt, by_county_MMR, by = "school_county") %>%
  inner_join(by_county_exempt, by = "school_county") %>%
  inner_join(by_county_nonmedexempt) %>%
  select(-c(students.x, schools.x, students.y, schools.y)) %>%
  arrange(desc(students))



names(county_group)
summary(county_group)
str(county_group)
glimpse(county_group)


#group by county, school_type

by_county_exempt_type <- vaccReported_NLT_10_NGT_2500_2013 %>%  group_by(school_county,school_type) %>% 
  summarize(mean_percent_exempt = round(mean(percent_exempt, na.rm=TRUE), 2), 
            median_percent_exempt = round(median(percent_exempt, na.rm=TRUE), 2), 
            max_percent_exempt = round(max(percent_exempt, na.rm=TRUE), 2), 
            min_percent_exempt = round(min(percent_exempt, na.rm=TRUE), 2), 
            schools=n(), 
            students=sum(enrolled, na.rm=TRUE)) %>%
  na.omit() %>% 
  arrange(desc(mean_percent_exempt))

by_county_nonmedexempt_type <- vaccReported_NLT_10_NGT_2500_2013 %>%  group_by(school_county, school_type) %>% 
  summarize(mean_percent_nonmedexempt = round(mean(percent_nonmedexempt, na.rm=TRUE), 2), 
            median_percent_nonmedexempt = round(median(percent_nonmedexempt, na.rm=TRUE), 2), 
            max_percent_nonmedexempt = round(max(percent_nonmedexempt, na.rm=TRUE), 2), 
            min_percent_nonmedexempt = round(min(percent_nonmedexempt, na.rm=TRUE), 2), 
            schools=n(), 
            students=sum(enrolled, na.rm=TRUE)) %>% 
  na.omit() %>% 
  arrange(desc(mean_percent_nonmedexempt))


by_county_nonmedexempt_type <- vaccReported_NLT_10_NGT_2500_2013 %>%  group_by(school_county, school_type) %>% 
  summarize(mean_percent_nonmedexempt = round(mean(percent_nonmedexempt, na.rm=TRUE), 2), 
            median_percent_nonmedexempt = round(median(percent_nonmedexempt, na.rm=TRUE), 2), 
            max_percent_nonmedexempt = round(max(percent_nonmedexempt, na.rm=TRUE), 2), 
            min_percent_nonmedexempt = round(min(percent_nonmedexempt, na.rm=TRUE), 2), 
            schools=n(), 
            students=sum(enrolled, na.rm=TRUE)) %>% 
  na.omit() %>% 
  arrange(desc(mean_percent_nonmedexempt))


by_county_medexempt_type <- vaccReported_NLT_10_NGT_2500_2013 %>%  group_by(school_county,school_type) %>% 
  summarize(mean_percent_medical_exempt = round(mean(percent_medical_exempt, na.rm=TRUE), 2), 
            median_percent_medical_exempt = round(median(percent_medical_exempt, na.rm=TRUE), 2), 
            max_percent_medical_exempt = round(max(percent_medical_exempt, na.rm=TRUE), 2), 
            min_percent_medical_exempt = round(min(percent_medical_exempt, na.rm=TRUE), 2), 
            schools=n(), 
            students=sum(enrolled, na.rm=TRUE)) %>% 
  na.omit() %>% 
  arrange(desc(mean_percent_medical_exempt))


by_county_MMR_type <- vaccReported_NLT_10_NGT_2500_2013 %>%  group_by(school_county, school_type) %>% 
  summarize(mean_percent_exempt_MMR = round(mean(percent_exempt_MMR, na.rm=TRUE), 2), 
            median_percent_exempt_MMR = round(median(percent_exempt_MMR, na.rm=TRUE), 2), 
            max_percent_exempt_MMR = round(max(percent_exempt_MMR, na.rm=TRUE), 2), 
            min_percent_exempt_MMR = round(min(percent_exempt_MMR, na.rm=TRUE), 2), 
            schools=n(), 
            students=sum(enrolled, na.rm=TRUE)) %>% 
  na.omit() %>% 
  arrange(desc(mean_percent_exempt_MMR))

#merge county/type groups and sort by students enrolled

county_group_type <- inner_join(by_county_medexempt_type, by_county_MMR_type, by = "school_county") %>%
  inner_join(by_county_exempt_type, by = "school_county") %>%
  inner_join(by_county_nonmedexempt_type) %>%
  select(-c(students.x, schools.x, students.y, schools.y, school_type.y, school_type.x)) %>%
  arrange(desc(students))



names(county_group_type)
summary(county_group_type)
str(county_group_type)
glimpse(county_group_type)

  

```

##Total Exemptions vs. Enrollment##
```{r echo=FALSE, Bivariate_Plots}

#total exemptions vs. enrollment

ggplot(data = vaccReported, aes(x = enrolled, y = total_exemptions)) +
  geom_line(alpha = .25,aes(color = school_year)) +
  geom_smooth()


ggplot(data = subset(vaccReported,enrolled <= 2500), aes(x = enrolled, y = total_exemptions)) +
  geom_line(alpha = .25,aes(color = school_year)) +
  geom_smooth()

```

For most of the data (enrollment up to ~1500) there is a linear relationship between total exemptions and number of students enrolled, this isn't surprising.  It would be more intersting to look at the rate, since it is normalized for population.

##Exemption rate vs enrollment##
```{r echo = FALSE}

ggplot(vaccReported, aes(x = enrolled, y = percent_exempt)) + 
  geom_point(alpha = .4, color = 'red')  +  
  geom_line(alpha = .5,stat = 'summary',fun.y = mean, linetype = 1, color = "black", size = 1) +
  scale_x_continuous(limits = c(0, 2000), breaks = seq(0,2000,250))

```

Mean percent exempt has high variance at low levels of enrollment.  This make sense, since a small change in exemptions represents a larger proportion of the population vs. schools with higher levels of enrollment.

```{r echo = FALSE}

ggplot(data = vaccReported, aes(x = enrolled, y = percent_exempt)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth()

ggplot(data = vaccReported, aes(x = enrolled, y = percent_medical_exempt)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth()


ggplot(data = vaccReported, aes(x = enrolled, y = percent_nonmedexempt)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth()



```

Percent exemption both general and specifc is largely flat across enrollment.

##Exemption rates vs. total exemptions##

```{r echo =FALSE}

ggplot(data = vaccReported, aes(x = total_exemptions, y = percent_medical_exempt)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth()

ggplot(data = vaccReported, aes(x = total_exemptions, y = percent_nonmedexempt)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth()

ggplot(data = vaccReported, aes(x = total_exemptions, y = percent_exempt_MMR)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth()

cor.test(vaccReported$total_exemptions,vaccReported$percent_exempt)
cor.test(vaccReported$total_exemptions,vaccReported$percent_medical_exempt)
cor.test(vaccReported$total_exemptions,vaccReported$percent_nonmedexempt)
cor.test(vaccReported$total_exemptions,vaccReported$percent_exempt_MMR)

```

Weak positive correlation between total exemptions and both total and specific exemption types.  Medical and non-medical exempt have ~ the same correlation to total exemptions.

##Specific exemptions vs. enrollment##

```{r echo=FALSE}

ggplot(data = vaccReported, aes(x = enrolled, y = medical_exempt )) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth()


ggplot(data = vaccReported, aes(x = enrolled, y = nonmedical_exempt)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth()


ggplot(data = vaccReported, aes(x = enrolled, y = exempt_MMR)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth()

cor.test(vaccReported$enrolled,vaccReported$nonmedical_exempt)
cor.test(vaccReported$enrolled,vaccReported$nonmedical_exempt)

```

Strong correlation between number of students enrolled and both non-medical exempt and MMR exemptions.

##Specific exemptions vs. total exemptions##

```{r echo=FALSE}

#not technically bivariate but nevertheless informative
ggplot(data = vaccReported, aes(x = total_exemptions, y = medical_exempt)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_point(alpha = .1, aes(size = enrolled)) +
  geom_smooth()


ggplot(data = vaccReported, aes(x = total_exemptions, y = nonmedical_exempt)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth()

ggplot(data = vaccReported, aes(x = total_exemptions, y = exempt_MMR)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth()

```

There is an interesting relationship between total exemptions and medical exemptions.  The correlation is weak up to about 150 exemptions and then takes off, becoming negative at about 300 exemptions.  Some of this is because there a very few schools beyond 150 exemptions, but note by the point size that this does not track strictly to school size (number of enrolled students).

There is a strong positive correlation between total exemptions and non-medical exemptions.  The is also a strong positive correlation between total exemptions and MMR exemptions, but not as strong as non-medical exemptions.  

##Specific exemption rates vs. total exemption rate##

```{r echo=FALSE}

ggplot(data = vaccReported, aes(x = percent_exempt, y = percent_medical_exempt)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth()

ggplot(data = vaccReported, aes(x = percent_exempt, y = percent_nonmedexempt)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth()


ggplot(data = vaccReported, aes(x = percent_exempt, y = percent_exempt_MMR)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth()

```

Medical exemption rates show a weak positive correlation to total exemption rates.  Both non-medical and MMR exemptions show a strong positive correlation to total exemption rates.

##Analyzing the grouped data##

Grouped data per above used for the following sections.

##Exemptions by school year##
```{r echo=FALSE}


ggplot(data = vaccReported, aes(x = school_year, y = total_exemptions)) +
  geom_boxplot()

ggplot(data = vaccReported, aes(x = school_year, y = medical_exempt)) +
  geom_boxplot()

ggplot(data = vaccReported, aes(x = school_year, y = nonmedical_exempt)) +
  geom_boxplot()

ggplot(data = vaccReported, aes(x = school_year, y = exempt_MMR)) +
  geom_boxplot()

ggplot(data = vaccReported, aes(x = school_year, y = total_exemptions)) +
  geom_boxplot() +
  geom_jitter(alpha = .1)

```

Except for the astounding number of outliers, there is not much to see from year to year, please move along.

##Exemptions by school type##
```{r echo=FALSE}

ggplot(data = vaccReported, aes(x = school_type, y = total_exemptions)) +
  geom_boxplot() +
  geom_jitter(alpha = .1)

ggplot(data = vaccReported, aes(x = school_type, y = medical_exempt)) +
  geom_boxplot() +
  geom_jitter(alpha = .1)
  

ggplot(data = vaccReported, aes(x = school_type, y = nonmedical_exempt)) +
  geom_boxplot() +
  geom_jitter(alpha = .1)

ggplot(data = vaccReported, aes(x = school_type, y = exempt_MMR)) +
  geom_boxplot() +
  geom_jitter(alpha = .1)

```

Public shcools have a higher median and larger spread of total exemptions, non-medical exemptions, and MMR exemptions.  The spread is very tight for medical exemptions, with comparable medians.  Some of the variability in the public schools can be explained by the fact that public schools have a larger range of enrolled students.  However, this doesn't explain observations for medical exemptions.

##Exemption rates by school year##

```{r echo=FALSE}


ggplot(data = vaccReported, aes(x = school_year, y = percent_exempt)) +
  geom_boxplot()

ggplot(data = vaccReported, aes(x = school_year, y = percent_medical_exempt)) +
  geom_boxplot()

ggplot(data = vaccReported, aes(x = school_year, y = percent_nonmedexempt)) +
  geom_boxplot()

ggplot(data = vaccReported, aes(x = school_year, y = percent_exempt_MMR)) +
  geom_boxplot()

```

Second verse same as the first.

##Exemption rates by school type##

```{r echo=FALSE}


ggplot(data = vaccReported, aes(x = school_type, y = percent_exempt)) +
  geom_boxplot() +
  geom_jitter(alpha = .1)

ggplot(data = vaccReported, aes(x = school_type, y = percent_medical_exempt)) +
  geom_boxplot() +
  geom_jitter(alpha = .1)

ggplot(data = vaccReported, aes(x = school_type, y = percent_nonmedexempt)) +
  geom_boxplot() +
  geom_jitter(alpha = .1)

ggplot(data = vaccReported, aes(x = school_type, y = percent_exempt_MMR)) +
  geom_boxplot() +
  geom_jitter(alpha = .1)
```

This is interesting to me.  The median level is about the same for public vs. private (not-public) but the spread is much greater or private.  I've looked at analyses from other states that essentially show that not all private schools, even by type of private school (Waldorf, Montessori) are created equal in terms of vaccination attitudes (tendency towards personal/non-medical exemptions).  I don't know if this is true of my data set, but there seems to be more variability in private vs. public schools.  These plots suggest this is true of non-medical and MMR exemptions, but not medical exemptions.





```{r echo =FALSE}


ggplot(data = vaccReported, aes(x = percent_nonmedexempt, y = percent_medical_exempt)) +
  geom_line() +
  geom_smooth()

ggplot(data = vaccReported, aes(x = percent_medical_exempt, y = percent_exempt_MMR)) +
  geom_line() +
  geom_smooth()

ggplot(data = vaccReported, aes(x = percent_nonmedexempt, y = percent_exempt_MMR)) +
  geom_line() +
  geom_smooth()


```

Medical and non-medical exemption rates or MMR exemption rates do not have a strong relationship.  Non-medical exemption rates and MMR exemption rates have strong positive relationship.


# Bivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. How did the feature(s) of interest vary with other features in the dataset?

* Total exemptions tracked with enrollment up to ~ 1500 students, but with high variance
* Exemption rates both general and specific do not track with enrollment but there is a weak positive correlation between exemption rates and total exemptions (makes mathematical sense).
* Non-medical and MMR exemption rates have a strong positive correlation with enrollment, but medical exemption rates do not.
* A very striking relationship is that between non-medical and MMR exemption rates and total exemption rate, in sharp contrast to the relationship between medical exemption rates and total exemption rate.
* Medical and non-medical exemption rates or MMR exemption rates do not have a strong relationship. Non-medical exemption rates and MMR exemption rates have strong positive relationship.

### Did you observe any interesting relationships between the other features (not the main feature(s) of interest)?

The median level is about the same for public vs. private (not-public) but the spread is much greater for private. I've looked at analyses from other states that essentially show that not all private schools, even by type of private school (Waldorf, Montessori) are created equal in terms of vaccinations attitudes (tendency towards personal/non-medical exemptions). I don't know if this is true of my data set, but there seems to be more variability in private vs. public schools. Plots suggest this is true of non-medical and MMR exemptions, but not medical exemptions.

Public shcools have a higher median and larger spread of total exemptions, non-medical exemptions, and MMR exemptions. The spread is very tight for medical exemptions, with comparable medians. Some of the variability in the public schools can be explained by the fact that public schools have a larger range of enrolled students. However, this doesn't explain observations for medical exemptions.

### What was the strongest relationship you found?

* Non-medical exemption rates and total exemption rate and MMR exemption rates and non-medical exemption rates. 


# Multivariate Plots Section

Technically some of the bivariate plots could be considred multivariate since rates are derivative of more than once variable.  Below I try to understand whether relationships signifcantly as a function of year or school type.  I also include some other visualizatons to help foster an understanding of the data.

```{r echo=FALSE, Multivariate_Plots}
#rates vs. total exemptions by year
ggplot(data = vaccReported, aes(x = total_exemptions, y = percent_medical_exempt)) +
  geom_line(alpha = .5) +
  geom_smooth(aes(color = school_year))


ggplot(data = vaccReported, aes(x = total_exemptions, y = percent_nonmedexempt)) +
  geom_line(alpha = .5) +
  geom_smooth(aes(color = school_year))


ggplot(data = vaccReported, aes(x = total_exemptions, y = percent_exempt_MMR)) +
  geom_line(alpha = .5) +
  geom_smooth(aes(color = school_year))


#specific exemptions vs. total exemptions by school year and by school type

ggplot(data = vaccReported, aes(x = total_exemptions, y = medical_exempt)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth(aes(color = school_year))


ggplot(data = vaccReported, aes(x = total_exemptions, y = nonmedical_exempt)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth(aes(color = school_year))

ggplot(data = vaccReported, aes(x = total_exemptions, y = exempt_MMR)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth(aes(color = school_year))


ggplot(data = vaccReported, aes(x = percent_exempt, y = percent_medical_exempt)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth(aes(color = school_year))


ggplot(data = vaccReported, aes(x = total_exemptions, y = medical_exempt)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth(aes(color = school_year))


ggplot(data = vaccReported, aes(x = total_exemptions, y = nonmedical_exempt)) +
  geom_line(alpha = .5)+
  geom_smooth(aes(color = school_type))

ggplot(data = vaccReported, aes(x = total_exemptions, y = exempt_MMR)) +
  geom_line(alpha = .5) +
  geom_smooth(aes(color = school_type))




#rate vs. rate by year

ggplot(data = vaccReported, aes(x = percent_exempt, y = percent_medical_exempt)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth(aes(color = school_year))

ggplot(data = vaccReported, aes(x = percent_exempt, y = percent_nonmedexempt)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth(aes(color = school_year))


ggplot(data = vaccReported, aes(x = percent_exempt, y = percent_exempt_MMR)) +
  geom_line(alpha = .5, aes(color = school_year)) +
  geom_smooth(aes(color = school_year))


ggplot(data = vaccReported, aes(x = percent_exempt, y = percent_medical_exempt)) +
  geom_line(alpha = .5) +
  geom_smooth(aes(color = school_type)) +
  facet_wrap(~school_year, ncol = 1)

ggplot(data = vaccReported, aes(x = percent_exempt, y = percent_nonmedexempt)) +
  geom_line(alpha = .5) +
  geom_smooth(aes(color = school_type)) +
  facet_wrap(~school_year, ncol = 1)


ggplot(data = vaccReported, aes(x = percent_exempt, y = percent_exempt_MMR)) +
  geom_line(alpha = .5) +
  geom_smooth(aes(color = school_type)) +
  facet_wrap(~school_year, ncol = 1)



ggplot(data = vaccReported, aes(x = percent_exempt, y = percent_exempt_MMR))  +
  geom_smooth(aes(color = school_type)) +
  geom_line(alpha = .5,stat = 'summary',fun.y = mean, linetype = 1, color = "black", size = 1) +
  geom_hline(y = 5) +
  geom_vline(x = 10)

ggplot(data = vaccReported_NLT_100_NGT_2500, aes(x = percent_exempt, y = percent_exempt_MMR))  +
  geom_smooth(aes(color = school_type)) +
  geom_point(alpha = .2, aes(size = enrolled)) +
  geom_hline(y = 5, color = "red", size = 1.5) +
  geom_vline(x = 10, color = "red", size = 1.5)

ggplot(data = vaccReported_NLT_100_NGT_2500, aes(x = percent_exempt_MMR, y = school_county)) +
  geom_point(alpha = .2) +
  geom_jitter(alpha = .2, aes(size = total_exemptions, color = school_type)) +
  geom_vline( x = 5, color = "red", size = 1)

#bar plots


#set up labels
aux.info <- vaccReported_NLT_100_NGT_2500 %>%  group_by(school_county) %>% summarize(Schools=n(), Students=sum(enrolled, na.rm=TRUE)) %>% na.omit()
aux.info$Summary <- paste(aux.info$Schools, " Schools enrolling\n", aux.info$Students, " Students", sep="")

county_group_2 <- county_group
as.factor(county_group_2$school_county)
ggplot(data= county_group, aes(y=mean_percent_exempt_MMR, x=school_county)) +
  geom_bar(position="dodge",stat="identity") + 
  coord_flip() 
  #annotate("text", x=seq(1, 38, 1), y=20, label=aux.info$Summary, size=2.1)

ggplot(data= county_group_type, aes(y=mean_percent_exempt_MMR, x=school_county, fill = school_type)) +
  geom_bar(position="dodge",stat="identity") + 
  coord_flip() 
  #annotate("text", x=seq(1, 38, 1), y=20, label=aux.info$Summary, size=2.1)

ggplot(data= county_group_type, aes(y=mean_percent_exempt_MMR, x=school_county, fill = school_type)) +
  geom_bar(position="stack",stat="identity") + 
  coord_flip() 





# melt county group to get mean percent exemption by type
melt_county_group <- gather(county_group,exemption_type,mean_percent_exemption_type,mean_percent_medical_exempt, mean_percent_nonmedexempt )


glimpse(county_group)
glimpse(melt_county_group)

ggplot(data= melt_county_group, aes(y=mean_percent_exemption_type, x=school_county, fill = exemption_type)) +
  geom_bar(position="stack",stat="identity") + 
  coord_flip()

#add a quartile rank column to melt county group

melt_county_group <- within(melt_county_group, mean_percent_exempt_quartile <- cut(mean_percent_exempt, quantile(mean_percent_exempt, probs=0:4/4), include.lowest=TRUE, labels=FALSE))

#change quartile rank to factor
as.factor(melt_county_group$mean_percent_exempt_quartile)

#set up labels

melt_county_group$labels <- paste(melt_county_group$schools, " Schools enrolling\n", melt_county_group$students, " Students", sep="")

quantile(melt_county_group$mean_percent_exempt)

#plot each quartile and display in grid
p1 = ggplot(data= subset(melt_county_group, mean_percent_exempt_quartile == 4), aes(y=mean_percent_exemption_type, x=school_county, fill = exemption_type)) +
  geom_bar(position="stack",stat="identity") + 
  coord_flip() #+
  #annotate("text", x=seq(1, 10, 1), y=20, label=melt_county_group$labels[melt_county_group$mean_percent_exempt_quartile == 4], size=2.1)

  
p2 = p1 = ggplot(data= subset(melt_county_group, mean_percent_exempt_quartile == 3), aes(y=mean_percent_exemption_type, x=school_county, fill = exemption_type)) +
  geom_bar(position="stack",stat="identity") + 
  coord_flip()
  
p3 = p1 = ggplot(data= subset(melt_county_group, mean_percent_exempt_quartile == 2), aes(y=mean_percent_exemption_type, x=school_county, fill = exemption_type)) +
  geom_bar(position="stack",stat="identity") + 
  coord_flip()
  
p4 = p1 = ggplot(data= subset(melt_county_group, mean_percent_exempt_quartile == 1), aes(y=mean_percent_exemption_type, x=school_county, fill = exemption_type)) +
  geom_bar(position="stack",stat="identity") + 
  coord_flip()

grid.arrange(p1,p2,p3,p4,ncol=1)

#order by ?

#make 2 cuts, counties >=10 total, counties between 5 and 10  make a case that MMR exemptions and total exemptions pretty closely related (or actually calculate what the cutoff should be for mean percent exempt base on its relationship to MMR exempt)  then plot etc. etc.



ggplot(data= subset(melt_county_group, mean_percent_exempt_quartile == 4), aes(y=mean_percent_exemption_type, x=school_county, fill = exemption_type)) +
  geom_bar(position="stack",stat="identity") + 
  coord_flip() +
  annotate("text", x=seq(1, 10, 1), y=23, label=unique(melt_county_group$labels[melt_county_group$mean_percent_exempt_quartile == 4]), size=4) +
  theme(legend.position = "top",legend.title=element_blank()) +
  geom_hline(y = 10, color = "red", size = 2) +
  geom_hline(y = 5, color = "red", size = 2)

```

# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. Were there features that strengthened each other in terms of looking at your feature(s) of interest?

I didn't observe any relationships that stand out fromt the bivariate plots section.  

### Were there any interesting or surprising interactions between features?

### OPTIONAL: Did you create any models with your dataset? Discuss the strengths and limitations of your model.

------

# Final Plots and Summary

### Plot One
```{r echo=FALSE, Plot_One}

```

### Description One


### Plot Two
```{r echo=FALSE, Plot_Two}

```

### Description Two


### Plot Three
```{r echo=FALSE, Plot_Three}

```

### Description Three

------

# Reflection


# References
* Udacity Forums and Coaches Lounge*
* [Hadley Wikhams Tidy Data manuscript and associate vignette](https://github.com/hadley/tidy-data)*
*[Quick R](http://www.statmethods.net/)*
* R for Dummies*
*[Cookbook for R](http://www.cookbook-r.com/)*
* R Cookbook by Paul Teetor (O'Reilly)*
* [Kieran Healy's Github Repo](https://github.com/kjhealy/vaccines-ca/blob/master/vaccines.r)*
* Stack Overflow*
